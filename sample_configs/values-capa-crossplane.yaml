# Example configuration for CAPA (AWS) with Crossplane-managed S3 storage
# This demonstrates the two-phase migration from manual bucket management to Crossplane

global:
  dnsService: "coredns"
  dnsNamespace: "kube-system"

loki:
  loki:
    storage:
      # Bucket names - these will match the Crossplane-created buckets
      bucketNames:
        chunks: giantswarm-my-installation-loki-chunks
        ruler: giantswarm-my-installation-loki-ruler
        admin: giantswarm-my-installation-loki-admin
      type: s3
      s3:
        region: eu-west-1
        # No credentials needed - IRSA handles authentication via IAM role

      ## Phase 1: Observe Mode Migration
      ## Enable this configuration first while old Bucket CR is still active
      provisioning:
        enabled: true
        observeOnly: true  # Crossplane will only watch, not manage
        provider: aws
        clusterName: "my-installation"  # MUST match your AWSCluster CR name
        clusterNamespace: org-giantswarm
        region: eu-west-1
        lifecycle:
          enabled: true
          retentionDays: 100
        iam:
          enabled: true
          roleName: "giantswarm-my-installation-loki-storage"
        tags:
          - key: team
            value: atlas
          - key: environment
            value: production

      ## Phase 2: Full Management (After testing Phase 1)
      ## 1. Verify Crossplane resources are in "Observe" state and synced
      ## 2. Remove the old Bucket CR from your configuration
      ## 3. Change observeOnly: false (or remove the line, default is false)
      ## 4. Apply the changes - Crossplane will now fully manage the buckets
      # provisioning:
      #   enabled: true
      #   observeOnly: false  # Full management mode
      #   provider: aws
      #   clusterName: "my-installation"
      #   clusterNamespace: org-giantswarm
      #   region: eu-west-1
      #   lifecycle:
      #     enabled: true
      #     retentionDays: 100
      #   iam:
      #     enabled: true
      #     roleName: "giantswarm-my-installation-loki-storage"
      #   tags:
      #     - key: team
      #       value: atlas
      #     - key: environment
      #       value: production
      #   region: eu-west-1
      #   clusterNamespace: org-giantswarm
      #   lifecycle:
      #     enabled: true
      #     retentionDays: 100
      #   iam:
      #     enabled: true
      #     roleNamePrefix: "loki-storage"
      #   tags:
      #     - key: team
      #       value: atlas
      #     - key: environment
      #       value: production

  # Service account with IAM role annotation for IRSA
  serviceAccount:
    create: true
    name: loki
    annotations:
      # This role ARN is created by Crossplane when iam.enabled: true
      # Replace ${AWS_ACCOUNT_ID} with your actual AWS account ID
      # Or use the pattern: giantswarm-{installationName}-loki-storage
      eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/giantswarm-my-installation-loki-storage"

  # Network policies for CAPA environments
  networkPolicy:
    enabled: true
    flavor: cilium
    egressWorld:
      enabled: true
    egressCoredns:
      enabled: true
    egressKubeApiserver:
      enabled: true
    egressMimir:
      enabled: true

  # Autoscaling configuration
  gateway:
    autoscaling:
      enabled: true
      minReplicas: 2
      targetCPUUtilizationPercentage: 90
      targetMemoryUtilizationPercentage: 90

  backend:
    autoscaling:
      enabled: true
      minReplicas: 2
      targetCPUUtilizationPercentage: 90
      targetMemoryUtilizationPercentage: 90

  read:
    autoscaling:
      enabled: true
      minReplicas: 2
      targetCPUUtilizationPercentage: 90
      targetMemoryUtilizationPercentage: 90

  write:
    autoscaling:
      enabled: true
      minReplicas: 2
      maxReplicas: 10
      targetMemoryUtilizationPercentage: 90

  # Caching configuration
  chunksCache:
    enabled: true
  resultsCache:
    enabled: true

  # Monitoring
  monitoring:
    serviceMonitor:
      enabled: true
    selfMonitoring:
      enabled: false

  # Disable MinIO for production
  minio:
    enabled: false

  # Disable test pods
  test:
    enabled: false
