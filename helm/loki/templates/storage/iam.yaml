{{- if and .Values.loki.enabled (.Values.loki.loki.storage.provisioning.enabled) (include "loki.storage.provisioning.isAWS" .) .Values.loki.loki.storage.provisioning.iam.enabled }}
{{- $region := .Values.loki.loki.storage.provisioning.region }}
{{- $roleName := include "loki.storage.iamRoleName" . }}
{{- $serviceAccountName := .Values.loki.serviceAccount.name | default "loki" }}
{{- $namespace := .Release.Namespace }}
{{- $tagsObj := include "loki.storage.tags" . | fromYaml }}
{{- $tags := $tagsObj.tags | default list }}
{{- $accountId := include "loki.storage.awsAccountId" . }}
{{- $oidcProvider := include "loki.storage.oidcProvider" . }}
{{- $providerConfigRef := .Values.loki.loki.storage.provisioning.providerConfigRef }}
{{- $isChinaRegion := hasPrefix "cn-" $region }}
{{- /* Build unique list of bucket names */ -}}
{{- $bucketMap := dict }}
{{- range $bucketType := list "chunks" "ruler" "admin" }}
  {{- $bucketName := include "loki.storage.bucketName" (dict "root" . "bucketType" $bucketType) }}
  {{- $_ := set $bucketMap $bucketName true }}
{{- end }}
{{- $uniqueBuckets := keys $bucketMap | sortAlpha }}
---
apiVersion: iam.aws.upbound.io/v1beta1
kind: Role
metadata:
  name: {{ $roleName }}
  namespace: {{ $namespace }}
  labels:
    {{- include "loki.labels" . | nindent 4 }}
    app.kubernetes.io/component: iam
  annotations:
    crossplane.io/external-name: {{ $roleName }}
spec:
  managementPolicies:
    {{- if .Values.loki.loki.storage.provisioning.observeOnly }}
    - Observe
    {{- else }}
    - "*"
    {{- end }}
  forProvider:
    assumeRolePolicy: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Principal": {
              "Federated": "arn:aws{{- if $isChinaRegion }}-cn{{- end }}:iam::{{ $accountId }}:oidc-provider/{{ $oidcProvider }}"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
              "StringEquals": {
                "{{ $oidcProvider }}:sub": "system:serviceaccount:{{ $namespace }}:{{ $serviceAccountName }}",
                "{{ $oidcProvider }}:aud": "sts.amazonaws.com{{- if $isChinaRegion }}.cn{{- end }}"
              }
            }
          }
        ]
      }
    inlinePolicy:
      - name: {{ $roleName }}
        policy: |
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Action": [
                  "s3:ListBucket",
                  "s3:PutObject",
                  "s3:GetObject",
                  "s3:DeleteObject"
                ],
                "Resource": [
                  {{- range $i, $bucketName := $uniqueBuckets }}
                  "arn:aws{{- if $isChinaRegion }}-cn{{- end }}:s3:::{{ $bucketName }}",
                  {{- end }}
                  {{- range $i, $bucketName := $uniqueBuckets }}
                  "arn:aws{{- if $isChinaRegion }}-cn{{- end }}:s3:::{{ $bucketName }}/*"{{- if lt $i (sub (len $uniqueBuckets) 1) }},{{- end }}
                  {{- end }}
                ]
              },
              {
                "Effect": "Allow",
                "Action": [
                  "s3:GetAccessPoint",
                  "s3:GetAccountPublicAccessBlock",
                  "s3:ListAccessPoints"
                ],
                "Resource": "*"
              }
            ]
          }
    {{- if $tags }}
    tags:
      {{- range $tag := $tags }}
      {{ index $tag "key" }}: {{ index $tag "value" | quote }}
      {{- end }}
    {{- end }}
  providerConfigRef:
    name: {{ $providerConfigRef }}
{{- end }}
