{{- if and .Values.loki.enabled (.Values.loki.loki.storage.provisioning.enabled) (include "loki.storage.provisioning.isAWS" .) }}
{{- $region := .Values.loki.loki.storage.provisioning.region }}
{{- $observeOnly := .Values.loki.loki.storage.provisioning.observeOnly }}
{{- $lifecycleEnabled := .Values.loki.loki.storage.provisioning.lifecycle.enabled }}
{{- $retentionDays := .Values.loki.loki.storage.provisioning.lifecycle.retentionDays }}
{{- $tags := include "loki.storage.tags" . | fromYaml }}
{{- range $bucketType := list "chunks" "ruler" "admin" }}
---
apiVersion: s3.aws.upbound.io/v1beta2
kind: Bucket
metadata:
  name: {{ include "loki.storage.bucketName" (dict "root" $ "bucketType" $bucketType) }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "loki.labels" $ | nindent 4 }}
    app.kubernetes.io/component: storage
    loki.giantswarm.io/bucket-type: {{ $bucketType }}
  annotations:
    {{- if $observeOnly }}
    crossplane.io/external-name: {{ include "loki.storage.bucketName" (dict "root" $ "bucketType" $bucketType) }}
    {{- end }}
spec:
  {{- if $observeOnly }}
  managementPolicies:
    - Observe
  {{- else }}
  managementPolicies:
    - "*"
  {{- end }}
  forProvider:
    region: {{ $region }}
    {{- if not $observeOnly }}
    tags:
      {{- range $tags }}
      {{ .key }}: {{ .value | quote }}
      {{- end }}
      Name: {{ include "loki.storage.bucketName" (dict "root" $ "bucketType" $bucketType) }}
      loki.giantswarm.io/bucket-type: {{ $bucketType }}
    {{- end }}
  providerConfigRef:
    name: default
---
{{- if and $lifecycleEnabled (not $observeOnly) }}
apiVersion: s3.aws.upbound.io/v1beta1
kind: BucketLifecycleConfiguration
metadata:
  name: {{ include "loki.storage.bucketName" (dict "root" $ "bucketType" $bucketType) }}-lifecycle
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "loki.labels" $ | nindent 4 }}
    app.kubernetes.io/component: storage
    loki.giantswarm.io/bucket-type: {{ $bucketType }}
spec:
  forProvider:
    bucketRef:
      name: {{ include "loki.storage.bucketName" (dict "root" $ "bucketType" $bucketType) }}
    region: {{ $region }}
    rule:
      - id: expire-old-logs
        status: Enabled
        expiration:
          - days: {{ $retentionDays }}
        filter:
          - prefix: ""
  providerConfigRef:
    name: default
{{- end }}
---
{{- if not $observeOnly }}
apiVersion: s3.aws.upbound.io/v1beta1
kind: BucketPublicAccessBlock
metadata:
  name: {{ include "loki.storage.bucketName" (dict "root" $ "bucketType" $bucketType) }}-public-access-block
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "loki.labels" $ | nindent 4 }}
    app.kubernetes.io/component: storage
    loki.giantswarm.io/bucket-type: {{ $bucketType }}
spec:
  forProvider:
    bucketRef:
      name: {{ include "loki.storage.bucketName" (dict "root" $ "bucketType" $bucketType) }}
    region: {{ $region }}
    blockPublicAcls: true
    blockPublicPolicy: true
    ignorePublicAcls: true
    restrictPublicBuckets: true
  providerConfigRef:
    name: default
{{- end }}
{{- end }}
{{- end }}
