global:
  image:
    # -- Overrides the Docker registry globally for all images
    registry: gsoci.azurecr.io
  # -- Overrides the priorityClassName for all pods
  priorityClassName:
  # -- configures cluster domain ("cluster.local" by default)
  clusterDomain: "cluster.local"
  # -- configures DNS service name
  dnsService: "coredns"
  # -- configures DNS service namespace
  dnsNamespace: "kube-system"

# -- Override the name of the chart
nameOverride: ""

loki:
  # You can make the whole chart ineffective by setting this one to "false"
  enabled: true

  # -- Override the name of the loki subchart
  nameOverride: ""

  loki:
    image:
      repository: giantswarm/loki

    # -- The SecurityContext for Loki pods
    podSecurityContext:
      fsGroup: 10001
      runAsGroup: 10001
      runAsNonRoot: true
      runAsUser: 10001
      seccompProfile:
        type: RuntimeDefault
    # -- The SecurityContext for Loki containers
    containerSecurityContext:
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL
      allowPrivilegeEscalation: false
      seccompProfile:
        type: RuntimeDefault
    # -- Loki Storage schema configuration
    #    Loki 3 requires a schema to be configured so we configure v13, the latest.
    #    Doc is here: https://grafana.com/docs/loki/latest/configure/storage/#schema-config
    schemaConfig:
      configs:
        - from: 2024-04-01
          object_store: s3
          store: tsdb
          schema: v13
          index:
            prefix: index_
            period: 24h
    # -- Loki Storage configuration
    storage:
      # --- Loki requires a bucket for chunks and the ruler.
      # TODO(user): Please provide these values if you are using object storage.
      bucketNames:
        chunks: chunks
        ruler: ruler
        admin: admin

  gateway:
    extraContainers:
      - name: dnsmasq
        image: "gsoci.azurecr.io/giantswarm/go-dnsmasq:release-1.0.7"
        imagePullPolicy: IfNotPresent
        args:
          - --listen
          - "127.0.0.1:8053"
          - --hostsfile=/etc/hosts
          - --enable-search
          - --verbose
        securityContext:
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL
          allowPrivilegeEscalation: false
          seccompProfile:
            type: RuntimeDefault
        resources:
          limits:
            memory: 100Mi
          requests:
            cpu: 10m
            memory: 10Mi
    nginxConfig:
      resolver: "127.0.0.1:8053 valid=60s"
    autoscaling:
      enabled: true
      minReplicas: 2
      targetCPUUtilizationPercentage: 90
      targetMemoryUtilizationPercentage: 90
    kedaAutoscaling:
      enabled: false
      horizontalPodAutoscalerConfig: {}
      pollingInterval: 30
      cooldownPeriod: 300
      minReplicas: 2
      maxReplicas: 10
      fallback: {}
      triggers:
      - type: memory
        metricType: Utilization
        metadata:
           # equivalent of targetMemoryUtilizationPercentage in HPA
          value: "90"
      - type: cpu
        metricType: Utilization
        metadata:
          # equivalent of targetCPUUtilizationPercentage in HPA
          value: "90"
    deploymentStrategy:
      type: RollingUpdate
      rollingUpdate:
        maxSurge: 0
        maxUnavailable: 1
    image:
      repository: giantswarm/nginx-unprivileged
    resources:
      limits:
        memory: 500Mi
      requests:
        memory: 50Mi
        cpu: 50m
    # -- The SecurityContext for gateway containers
    podSecurityContext:
      fsGroup: 101
      runAsGroup: 101
      runAsNonRoot: true
      runAsUser: 101
      seccompProfile:
        type: RuntimeDefault
    # -- The SecurityContext for gateway containers
    containerSecurityContext:
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL
      allowPrivilegeEscalation: false
      seccompProfile:
        type: RuntimeDefault
    # -- Gateway API Routes for loki-gateway
    route:
      main:
        # -- Enables or disables the route
        enabled: false

        # -- Set the route apiVersion, e.g. gateway.networking.k8s.io/v1 or gateway.networking.k8s.io/v1alpha2
        apiVersion: gateway.networking.k8s.io/v1
        # -- Set the route kind
        # Valid options are GRPCRoute, HTTPRoute, TCPRoute, TLSRoute, UDPRoute
        kind: HTTPRoute

        annotations: {}
        labels: {}

        hostnames: []
        # - my-filter.example.com
        parentRefs: []
        # - name: acme-gw

        matches:
          - path:
              type: PathPrefix
              value: /

        ## Filters define the filters that are applied to requests that match this rule.
        filters: []

        ## Additional custom rules that can be added to the route
        additionalRules: []

        securityPolicy:
          enabled: false
          annotations: {}
          labels: {}
          # basicAuth:
          #   users:
          #     name: <secret_name>

        backendTrafficPolicy:
          enabled: false
          annotations: {}
          labels: {}
          timeout:
            tcp:
              connectTimeout: 60s

  backend:
    autoscaling:
      enabled: true
      minReplicas: 2
      targetCPUUtilizationPercentage: 90
      targetMemoryUtilizationPercentage: 90
    resources:
      limits:
        memory: 3Gi
      requests:
        memory: 1Gi
        cpu: 200m

  read:
    autoscaling:
      enabled: true
      minReplicas: 2
      targetCPUUtilizationPercentage: 90
      targetMemoryUtilizationPercentage: 90
    kedaAutoscaling:
      enabled: false
      horizontalPodAutoscalerConfig: {}
      pollingInterval: 30
      cooldownPeriod: 300
      minReplicas: 2
      maxReplicas: 10
      fallback: {}
      triggers:
      - type: memory
        metricType: Utilization
        metadata:
           # equivalent of targetMemoryUtilizationPercentage in HPA
          value: "90"
      - type: cpu
        metricType: Utilization
        metadata:
          # equivalent of targetCPUUtilizationPercentage in HPA
          value: "90"
    resources:
      limits:
        memory: 3Gi
      requests:
        memory: 1Gi
        cpu: 200m
    extraArgs:
      - -querier.multi-tenant-queries-enabled

  write:
    autoscaling:
      enabled: true
      minReplicas: 2
      maxReplicas: 10
      targetMemoryUtilizationPercentage: 90
    resources:
      limits:
        memory: 4Gi
      requests:
        memory: 3Gi
        cpu: 500m

  # -- Caching configuration
  chunksCache:
    enabled: true
  resultsCache:
    enabled: true

  # -- Canary configuration
  # The Loki canary pushes logs to and queries from this loki installation to test
  # that it's working correctly
  lokiCanary:
    enabled: false
    kind: Deployment
    replicas: 3
    # -- Image to use for loki canary
    image:
      # -- The Docker registry
      registry: gsoci.azurecr.io
      # -- Docker image repository
      repository: giantswarm/loki-canary
    # -- The SecurityContext for Loki pods
    podSecurityContext:
      fsGroup: 10001
      runAsGroup: 10001
      runAsNonRoot: true
      runAsUser: 10001
      seccompProfile:
        type: RuntimeDefault
    # -- The SecurityContext for Loki containers
    containerSecurityContext:
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL
      allowPrivilegeEscalation: false
    # -- Update strategy for the `loki-canary` Daemonset pods
    updateStrategy:
      type: RollingUpdate
      rollingUpdate:
        maxUnavailable: 1

  # -- Configuration of monitoring components
  monitoring:
    dashboards:
      enabled: false
    rules:
      enabled: false
    alerts:
      enabled: false
    serviceMonitor:
      enabled: true
    selfMonitoring:
      enabled: false
      grafanaAgent:
        installOperator: false

  # -- Configuration of Loki's network policy
  networkPolicy:
    enabled: true
    flavor: cilium
    egressWorld:
      # -- Enable additional cilium egress rules to external world for write, read and backend.
      enabled: true
    egressCoredns:
      # -- Enable additional cilium egress rules to coredns for write, read and backend.
      enabled: true
    egressKubeApiserver:
      # -- Enable additional cilium egress rules to kube-apiserver for backend.
      enabled: true
    egressMimir:
      # -- Enable additional cilium egress rules to Mimir for backend.
      enabled: true

  # -- Configuration of Loki's service account
  serviceAccount:
    # -- Specifies whether a ServiceAccount should be created
    create: true
    # -- The name of the ServiceAccount to use.
    # If not set and create is true, a name is generated using the fullname template
    name: loki
    # -- Image pull secrets for the service account
    imagePullSecrets: []
    # -- Annotations for the service account
    # Note: When crossplane.enabled is true with IAM enabled,
    # the eks.amazonaws.com/role-arn annotation will be added automatically
    annotations: {}
    # -- Labels for the service account
    labels: {}
    # -- Set this toggle to false to opt out of automounting API credentials for the service account
    automountServiceAccountToken: true

  sidecar:
    image:
      repository: giantswarm/k8s-sidecar
    securityContext:
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL
      allowPrivilegeEscalation: false
      seccompProfile:
        type: RuntimeDefault
    resources:
      limits:
        cpu: 100m
        memory: 100Mi
      requests:
        cpu: 50m
        memory: 50Mi

  test:
    enabled: false

# -- Crossplane configuration for cloud resource provisioning
crossplane:
  # -- Enable automated storage provisioning via Crossplane
  enabled: false
  # -- Cloud provider type: 'aws' for CAPA, 'azure' for CAPZ
  provider: aws
  # -- Cloud region for resources
  region: ""
  # -- Cluster name (should match the AWSCluster/AzureCluster CR name)
  clusterName: ""
  # -- Namespace where the cluster CR exists
  clusterNamespace: org-giantswarm
  # -- Crossplane ProviderConfig name
  providerConfigRef: default
  # -- Observe mode: Crossplane watches existing resources without managing them
  # Set to true for Phase 1 migration, false for full management
  observeOnly: false
  # -- Additional tags to apply to all storage resources
  # Tags from cluster CR will be merged automatically
  tags: []
  # - key: team
  #   value: atlas

  # -- AWS-specific configuration
  aws:
    # -- Enable AWS resources (S3, IAM)
    enabled: false
    # -- S3 bucket configuration
    bucket:
      # -- S3 bucket name for all Loki storage
      name: ""
      # -- Number of days to retain logs before expiration
      lifecycleDays: 100
    # -- IAM Role configuration for IRSA
    iam:
      # -- Enable IAM role creation via Crossplane
      enabled: true
      # -- IAM role name (should match existing role when using observeOnly mode)
      # Example: giantswarm-my-installation-loki-storage
      roleName: ""

  # -- Azure-specific configuration
  azure:
    # -- Enable Azure resources (Storage Account, Container)
    enabled: false
    # -- Storage container configuration
    container:
      # -- Container name for all Loki storage
      name: ""
      # -- Number of days to retain logs before expiration (optional, omit to disable lifecycle)
      lifecycleDays: 100
